<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Haushaltskalender ‚Äî Kontextmen√º + Person bleibt ausgew√§hlt</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --green: #43a047;
      --blue: #1e88e5;
      --red: #e53935;
      --purple: #8e24aa;
      --sidebar: #2196F3;
      --task: #64B5F6;
      --card-bg: #ffffff;
      --today: #d9fdd3;
    }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; background: #f5f5f5; }
    header { position: fixed; top: 0; left: 0; right: 0; background: #4CAF50; color: white; padding: 10px; display: flex; justify-content: center; align-items: center; z-index: 300; }
    header h1 { margin: 0; font-size: 1.4em; text-align: center; flex: 1; }
    .top-controls { position: absolute; right: 10px; display: flex; align-items: center; gap: 10px; }
    #trash { font-size: 1.5em; cursor: pointer; position: relative; }
    #trash:hover::after { content: "Zum L√∂schen hierher ziehen"; position: absolute; top: 120%; left: -50%; background: #333; color: #fff; font-size: 0.8em; padding: 4px 6px; border-radius: 4px; white-space: nowrap; }

    #person-bar { margin-top: 50px; background: var(--card-bg); padding: 10px; display: flex; justify-content: center; gap: 12px; position: sticky; top: 50px; z-index: 200; }
    .person { padding: 8px 14px; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.12); transition: transform 0.12s, box-shadow 0.12s; color: white; font-weight: 700; }
    .person.selected { border: 3px solid black; transform: scale(1.05); box-shadow: 0 6px 14px rgba(0,0,0,0.18); }
    .person[data-name="Lisa"] { background: var(--green); }
    .person[data-name="Wasja"] { background: var(--blue); }
    .person[data-name="Hanna"] { background: var(--red); }
    .person[data-name="Ella"] { background: var(--purple); }
    .person[data-name="Alle"] {
      background: linear-gradient(45deg, var(--green) 0%, var(--blue) 33%, var(--red) 66%, var(--purple) 100%);
    }

    .content { display: flex; margin-top: 10px; }
    #task-sidebar { width: 240px; background: var(--sidebar); color: white; padding: 15px; border-radius: 12px; margin: 10px; height: calc(100vh - 170px); overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.12); display: flex; flex-direction: column; justify-content: space-between; }
    #task-sidebar h3 { margin-top: 0; }
    .task { background: var(--task); padding: 8px 10px; margin: 6px 0; border-radius: 10px; cursor: grab; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }

    #calendar-box { flex: 1; margin: 10px; background: var(--card-bg); border-radius: 16px; padding: 15px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    #calendar-header { display: flex; justify-content: center; align-items: center; gap: 20px; font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
    #calendar-header button { background: var(--green); color: white; border: none; padding: 4px 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    #calendar-header button:hover { background: #388e3c; }
    #weekday-row { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 700; margin-bottom: 8px; color: #555; }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); grid-gap: 12px; margin-top: 5px; }
    .day { border: 1px solid #eee; min-height: 110px; padding: 8px; position: relative; background: #fafafa; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); display:flex; flex-direction:column; }
    .day.today { background: var(--today); }
    .date-label { font-size: 0.85em; font-weight: 700; margin-bottom: 6px; }
    .assignment { margin: 4px 0; padding: 6px 8px; border-radius: 10px; font-size: 0.9em; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,0.12); color: white; }
    .assignment.Lisa { background: var(--green); }
    .assignment.Wasja { background: var(--blue); }
    .assignment.Hanna { background: var(--red); }
    .assignment.Ella { background: var(--purple); }
    .assignment.Alle { background: linear-gradient(45deg, var(--green) 0%, var(--blue) 33%, var(--red) 66%, var(--purple) 100%); }

    #add-task-box { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
    #newTaskInput { width: 100%; padding: 6px; border-radius: 8px; border: none; }
    #add-task-box button { background: var(--green); color: white; border: none; padding: 8px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: background 0.2s, transform 0.1s; }
    #add-task-box button:hover { background: #388e3c; transform: scale(1.03); }

    /* Kontextmen√º */
    #contextMenu {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border-radius: 6px;
      z-index: 1000;
    }
    #contextMenu ul { list-style: none; margin: 0; padding: 5px 0; }
    #contextMenu li { padding: 6px 16px; cursor: pointer; }
    #contextMenu li:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <header>
    <h1>Haushaltskalender</h1>
    <div class="top-controls">
      <div id="trash" title="Zum L√∂schen hierher ziehen">üóëÔ∏è</div>
    </div>
  </header>

  <div id="person-bar">
    <div class="person" data-name="Lisa" onclick="selectPerson('Lisa')">Lisa</div>
    <div class="person" data-name="Wasja" onclick="selectPerson('Wasja')">Wasja</div>
    <div class="person" data-name="Hanna" onclick="selectPerson('Hanna')">Hanna</div>
    <div class="person" data-name="Ella" onclick="selectPerson('Ella')">Ella</div>
    <div class="person" data-name="Alle" onclick="selectPerson('Alle')">Alle</div>
  </div>

  <div class="content">
    <div id="task-sidebar">
      <div>
        <h3>Aufgaben</h3>
        <div id="task-pool"></div>
      </div>
      <div id="add-task-box">
        <label><input type="checkbox" id="repeatWeekly"> w√∂chentlich wiederholen</label>
        <input type="text" id="newTaskInput" placeholder="Neue Aufgabe">
        <button onclick="addTask()">+ Aufgabe hinzuf√ºgen</button>
      </div>
    </div>

    <div id="calendar-box">
      <div id="calendar-header">
        <button onclick="prevMonth()">‚Äπ</button>
        <span id="monthYear"></span>
        <button onclick="nextMonth()">‚Ä∫</button>
      </div>
      <div id="weekday-row">
        <div>Mo</div><div>Di</div><div>Mi</div><div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
      </div>
      <div id="calendar"></div>
    </div>
  </div>

  <div id="contextMenu">
    <ul>
      <li onclick="deleteSingle()">Diesen Eintrag l√∂schen</li>
      <li onclick="deleteAllWeekly()">Alle wiederkehrenden Eintr√§ge l√∂schen</li>
    </ul>
  </div>

  <script>
    let currentMonth, currentYear;
    let selectedPerson = null;
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [
      "Geschirrsp√ºler ausr√§umen", "Staubsaugen Wohnzimmer", "Bad putzen",
      "M√ºll rausbringen", "W√§sche zusammenlegen", "Einkaufsliste schreiben"
    ];
    let assignments = JSON.parse(localStorage.getItem('assignments')) || {};
    let savedState = JSON.parse(localStorage.getItem('calendarState')) || {};
    if (savedState.month !== undefined) { currentMonth = savedState.month; currentYear = savedState.year; }
    else { let now = new Date(); currentMonth = now.getMonth(); currentYear = now.getFullYear(); }

    let contextMenu = document.getElementById("contextMenu");
    let contextTarget = null;

    function saveState() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
      localStorage.setItem('assignments', JSON.stringify(assignments));
      localStorage.setItem('calendarState', JSON.stringify({month: currentMonth, year: currentYear}));
    }

    function addTask() {
      let input = document.getElementById('newTaskInput');
      let value = input.value.trim();
      if (value) { tasks.push(value); input.value = ""; renderTasks(); saveState(); }
    }

    function renderTasks() {
      let pool = document.getElementById('task-pool');
      pool.innerHTML = "";
      tasks.forEach((task) => {
        let div = document.createElement('div');
        div.className = "task";
        div.draggable = true;
        div.textContent = task;
        div.addEventListener('dragstart', e => e.dataTransfer.setData("text/task", task));
        div.onclick = () => assignToSelected(task);
        pool.appendChild(div);
      });
    }

    function renderCalendar() {
      let monthYear = document.getElementById('monthYear');
      let cal = document.getElementById('calendar');
      let monthText = new Date(currentYear, currentMonth).toLocaleString('de-DE', {month: 'long', year: 'numeric'});
      monthYear.textContent = monthText;
      cal.innerHTML = "";
      let firstDay = new Date(currentYear, currentMonth, 1).getDay();
      if (firstDay === 0) firstDay = 7;
      let daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
      let today = new Date();

      for (let i=1; i<firstDay; i++) { cal.appendChild(document.createElement('div')); }
      for (let d=1; d<=daysInMonth; d++) {
        let cell = document.createElement('div');
        cell.className = "day";
        if (d === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
          cell.classList.add("today");
        }
        cell.dataset.date = `${d}.${currentMonth+1}.${currentYear}`;
        let label = document.createElement('div');
        label.className = "date-label";
        label.textContent = `${d}.${currentMonth+1}.${currentYear}`;
        cell.appendChild(label);
        cell.ondragover = e => e.preventDefault();
        cell.ondrop = e => {
          let task = e.dataTransfer.getData("text/task");
          if (task) addAssignment(cell.dataset.date, task);
        };

        for (let date in assignments) {
          let items = assignments[date];
          items.forEach(a => {
            let [day, month, year] = date.split('.').map(Number);
            let baseDate = new Date(year, month-1, day);
            let currentDate = new Date(currentYear, currentMonth, d);
            let diff = (currentDate - baseDate) / (1000*60*60*24);
            if (diff >= 0 && (a.repeat === "weekly" ? diff % 7 === 0 : diff === 0)) {
              let div = document.createElement('div');
              div.className = "assignment " + (a.person || "");
              div.textContent = a.task;
              div.draggable = true;
              div.addEventListener('dragstart', e => e.dataTransfer.setData("text/assignment", JSON.stringify({date: date, task: a.task, person: a.person})));
              // Kontextmen√º
              div.addEventListener('contextmenu', e => {
                e.preventDefault();
                contextTarget = {date: date, task: a.task, person: a.person, repeat: a.repeat};
                contextMenu.style.display = "block";
                contextMenu.style.left = e.pageX + "px";
                contextMenu.style.top = e.pageY + "px";
              });
              cell.appendChild(div);
            }
          });
        }
        cal.appendChild(cell);
      }
    }

    function addAssignment(date, task) {
      if (!task) return;
      if (!assignments[date]) assignments[date] = [];
      let repeatWeekly = document.getElementById("repeatWeekly").checked;
      assignments[date].push({task: task, person: selectedPerson, repeat: repeatWeekly ? "weekly" : null});
      saveState();
      renderCalendar();
    }

    function selectPerson(name) {
      selectedPerson = name;
      document.querySelectorAll('.person').forEach(p => p.classList.remove("selected"));
      document.querySelector('.person[data-name="'+name+'"]').classList.add("selected");
    }

    function prevMonth() { currentMonth--; if (currentMonth<0) { currentMonth=11; currentYear--; } saveState(); renderCalendar(); }
    function nextMonth() { currentMonth++; if (currentMonth>11) { currentMonth=0; currentYear++; } saveState(); renderCalendar(); }

    let trash = document.getElementById('trash');
    trash.ondragover = e => e.preventDefault();
    trash.ondrop = e => {
      let task = e.dataTransfer.getData("text/task");
      if (task) {
        tasks = tasks.filter(t => t !== task);
        for (let d in assignments) {
          assignments[d] = assignments[d].filter(a => a.task !== task);
        }
      }
      let as = e.dataTransfer.getData("text/assignment");
      if (as) {
        let a = JSON.parse(as);
        assignments[a.date] = assignments[a.date].filter(x => !(x.task===a.task && x.person===a.person));
      }
      saveState();
      renderTasks();
      renderCalendar();
    };

    // Kontextmen√º Aktionen
    function deleteSingle() {
      if (!contextTarget) return;
      assignments[contextTarget.date] = assignments[contextTarget.date].filter(a => !(a.task===contextTarget.task && a.person===contextTarget.person));
      saveState();
      renderCalendar();
      closeContextMenu();
    }
    function deleteAllWeekly() {
      if (!contextTarget) return;
      for (let d in assignments) {
        assignments[d] = assignments[d].filter(a => !(a.task===contextTarget.task && a.person===contextTarget.person));
      }
      saveState();
      renderCalendar();
      closeContextMenu();
    }

    function closeContextMenu() {
      contextMenu.style.display = "none";
      contextTarget = null;
    }

    window.addEventListener("click", closeContextMenu);
    window.addEventListener("keydown", e => { if (e.key === "Escape") closeContextMenu(); });

    renderTasks();
    renderCalendar();
  </script>
</body>
</html>
